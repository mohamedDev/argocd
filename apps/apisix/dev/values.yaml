# Configuration APISIX pour GKE

replicaCount: 2

image:
  repository: apache/apisix
  tag: "3.13.0-ubuntu" # derni√®re version stable du chart officiel
  pullPolicy: IfNotPresent

# Service configuration
service:
  type: NodePort
  http:
    enabled: true
    servicePort: 80
    containerPort: 9080
    nodePort: 30088
  tls:
    servicePort: 443
    containerPort: 9443
    nodePort: 30443

# Ingress (d√©sactiv√© ici, GKE LoadBalancer sera plus adapt√©)
ingress:
  enabled: false

# Resources (√©quilibr√©es pour GKE n1-standard-2)
resources:
  limits:
    cpu: 500m
    memory: 512Mi
  requests:
    cpu: 250m
    memory: 256Mi

# Autoscaling horizontal (HPA)
autoscaling:
  enabled: true
  minReplicas: 1
  maxReplicas: 3
  targetCPUUtilizationPercentage: 70

# etcd embarqu√© (√©viter en prod GKE, privil√©gier un etcd externe ou Cloud Spanner/Cloud SQL)
etcd:
  enabled: true
  replicaCount: 1 # R√©duire √† 1 pour local-path
  persistence:
    enabled: true
    storageClass: "local-path"
    size: 8Gi

# APISIX core config
apisix:
  enableHTTP2: true
  enableIPv6: false

  ssl:
    enabled: true
    containerPort: 9443
    enableHTTP3: false

  admin:
    enabled: true
    type: NodePort # üëà Change ClusterIP ‚Üí NodePort
    port: 9180 # Port interne du Pod (container)
    servicePort: 9180 # Port du service expos√©
    nodePort: 30980
    cors: true
    credentials:
      admin: "changeme-admin-key"
      viewer: "changeme-viewer-key"
      secretName: "" # tu peux mettre un secret GKE si tu veux externaliser les cl√©s
    allow:
      ipList:
        - "0.0.0.0/0"

  plugins:
    - api-breaker
    - authz-keycloak
    - basic-auth
    - batch-requests
    - consumer-restriction
    - cors
    - echo
    - fault-injection
    - grpc-transcode
    - hmac-auth
    - http-logger
    - ip-restriction
    - jwt-auth
    - key-auth
    - limit-conn
    - limit-count
    - limit-req
    - node-status
    - openid-connect
    - prometheus
    - proxy-cache
    - proxy-mirror
    - proxy-rewrite
    - redirect
    - referer-restriction
    - request-id
    - request-validation
    - response-rewrite
    - serverless-pre-function
    - serverless-post-function
    - sls-logger
    - syslog
    - tcp-logger
    - udp-logger
    - uri-blocker
    - wolf-rbac
    - zipkin
    - server-info
    - traffic-split
    - kafka-logger

# Monitoring
metrics:
  serviceMonitor:
    enabled: false

# Sp√©cifique GKE
nodeSelector:
  kubernetes.io/os: linux

tolerations: []

# Pas d‚Äôanti-affinit√© forc√©e (utile sur petit cluster GKE)
affinity: {}
