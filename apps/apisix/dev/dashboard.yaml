# ETCD Deployment
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: etcd
spec:
  replicas: 1
  selector:
    matchLabels:
      app: etcd
  template:
    metadata:
      labels:
        app: etcd
    spec:
      containers:
        - name: etcd
          image: quay.io/coreos/etcd:v3.5.4
          command:
            - etcd
            - --name=etcd0
            - --data-dir=/etcd-data
            - --listen-client-urls=http://0.0.0.0:2379
            - --advertise-client-urls=http://0.0.0.0:2379
            - --listen-peer-urls=http://0.0.0.0:2380
            - --initial-advertise-peer-urls=http://0.0.0.0:2380
            - --initial-cluster=etcd0=http://0.0.0.0:2380
            - --initial-cluster-token=etcd-cluster-1
            - --initial-cluster-state=new
          ports:
            - containerPort: 2379
            - containerPort: 2380
          volumeMounts:
            - name: etcd-data
              mountPath: /etcd-data
      volumes:
        - name: etcd-data
          emptyDir: {}

---
apiVersion: v1
kind: Service
metadata:
  name: etcd-service
spec:
  selector:
    app: etcd
  ports:
    - name: client
      port: 2379
      targetPort: 2379

# APISIX Configuration
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: apisix-config
data:
  config.yaml: |
    deployment:
      role: traditional
      role_traditional:
        config_provider: etcd
      etcd:
        host:
          - "http://etcd-service:2379"
        prefix: "/apisix"
        timeout: 30
      admin:
        enable_admin: true
        enable_admin_cors: true
        allow_admin:
          - 0.0.0.0/0
        admin_listen:
          ip: 0.0.0.0
          port: 9180
        admin_key:
          - name: "admin"
            key: "a1b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6"
            role: admin
        port_admin: 9180
    apisix:
      node_listen: 9080
      enable_ipv6: false
      ssl:
        enable: false
        listen:
          - port: 9443
        ssl_protocols: "TLSv1.2 TLSv1.3"
    plugin_attr:
      prometheus: {}

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: apisix
spec:
  replicas: 1
  selector:
    matchLabels:
      app: apisix
  template:
    metadata:
      labels:
        app: apisix
    spec:
      initContainers:
        - name: wait-for-etcd
          image: busybox:1.35
          command: ["sh", "-c"]
          args:
            - |
              echo "Waiting for etcd to be ready..."
              until nc -z etcd-service 2379; do
                echo "Waiting for etcd-service:2379..."
                sleep 2
              done
              echo "ETCD is ready!"
      containers:
        - name: apisix
          image: apache/apisix:3.6.0-debian
          ports:
            - containerPort: 9080
            - containerPort: 9180
            - containerPort: 9443
          volumeMounts:
            - name: apisix-config
              mountPath: /usr/local/apisix/conf/config.yaml
              subPath: config.yaml
          env:
            - name: APISIX_STAND_ALONE
              value: "false"
          command: ["/bin/sh", "-c"]
          args:
            - |
              echo "Starting APISIX..."
              /usr/local/openresty/luajit/bin/luajit ./apisix/cli/apisix.lua init
              /usr/local/openresty/luajit/bin/luajit ./apisix/cli/apisix.lua init_etcd
              exec /usr/local/openresty/luajit/bin/luajit ./apisix/cli/apisix.lua start
      volumes:
        - name: apisix-config
          configMap:
            name: apisix-config

---
apiVersion: v1
kind: Service
metadata:
  name: apisix-service
spec:
  selector:
    app: apisix
  type: NodePort
  ports:
    - name: gateway
      port: 9080
      targetPort: 9080
      nodePort: 30080
    - name: admin
      port: 9180
      targetPort: 9180
      nodePort: 30180
    - name: ssl
      port: 9443
      targetPort: 9443
      nodePort: 30443
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: apisix-dashboard-config
data:
  conf.yaml: |
    conf:
      listen:
        host: 0.0.0.0
        port: 9000
      etcd:
        endpoints:
          - etcd-service:2379
        prefix: "/apisix"
      log:
        error_log:
          level: warn
          file_path: logs/error.log
        access_log:
          file_path: logs/access.log

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: apisix-dashboard
spec:
  replicas: 1
  selector:
    matchLabels:
      app: apisix-dashboard
  template:
    metadata:
      labels:
        app: apisix-dashboard
    spec:
      containers:
        - name: apisix-dashboard
          image: apache/apisix-dashboard:3.0.1-alpine
          ports:
            - containerPort: 9000
          volumeMounts:
            - name: dashboard-config
              mountPath: /usr/local/apisix-dashboard/conf/conf.yaml
              subPath: conf.yaml
---
apiVersion: v1
kind: Service
metadata:
  name: apisix-dashboard-service
spec:
  selector:
    app: apisix-dashboard
  type: NodePort
  ports:
    - name: dashboard
      port: 9000
      targetPort: 9000
      nodePort: 30000
